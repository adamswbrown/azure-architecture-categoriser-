<?xml version="1.0" encoding="UTF-8"?>
<!--
================================================================================
  PRODUCTION CONFIGURATION - Static File Serving with Authentication
================================================================================

  Use this configuration for PRODUCTION deployments where:
  - Frontend is deployed as static files (Next.js output: 'export')
  - Static files are served directly by IIS from the /chat directory
  - No Node.js server running on port 3000
  - Authentication is required (.AspNet.Cookies from main app)

  Deployment Steps:
  1. Build frontend: cd frontend && npm run build
  2. Copy contents of frontend/out/ to C:\inetpub\wwwroot\chat\
  3. Copy this file to: C:\inetpub\wwwroot\chat\web.config
  4. Ensure CopilotKit server is running on port 8001
  5. Ensure Python backend is running on port 8002
  6. Restart IIS or recycle application pool

  For DEVELOPMENT with Node.js server, use web-auth.config instead.
  For PRODUCTION without authentication, use web-static.config instead.

================================================================================
-->
<configuration>
  <system.webServer>

    <!-- ARR reverse proxy settings are configured in applicationHost.config via location path -->
    <!-- See New-ChatReverseProxyApplication function for configuration -->
    <!-- <proxy> element cannot be set in web.config (AppHostOnly restriction) -->

    <!-- Optional but recommended for SSE -->
    <caching enabled="false" enableKernelCache="false" />
    <urlCompression doDynamicCompression="false" doStaticCompression="false" />

    <!-- CSP Headers -->
    <httpProtocol>
      <customHeaders>
        <remove name="Content-Security-Policy" />
        <add name="Content-Security-Policy"
             value="default-src 'self' https: data:;
                    script-src 'self' 'unsafe-inline';
                    style-src 'self' 'unsafe-inline';
                    img-src 'self' data:;
                    connect-src 'self' https://*.drmigrate.com.au;
                    frame-ancestors 'none';
                    base-uri 'self'" />
      </customHeaders>
    </httpProtocol>

    <rewrite>
      <rules>
        <!-- ============================================================================
             PHASE 1 AUTHENTICATION
             Validate that requests have .AspNet.Cookies from main app authentication
             If cookie missing → return 401 Unauthorized
             ============================================================================ -->

        <!-- 0) REQUIRE AUTHENTICATION: Check for .AspNet.Cookies presence -->
        <rule name="Require Authentication Cookie" stopProcessing="true">
          <match url="^(.*)$" />
          <conditions>
            <!-- Check if .AspNet.Cookies cookie is missing (negate=true means "if NOT found") -->
            <add input="{HTTP_COOKIE}" pattern="\.AspNet\.Cookies" negate="true" />

            <!-- EXCEPTION 1: Allow static assets and CopilotKit API (they don't need auth) -->
            <add input="{REQUEST_URI}" pattern="^/chat/(_next|\.well-known|favicon|copilotkit-api)" negate="true" />
          </conditions>
          <action type="CustomResponse" statusCode="401" statusReason="Unauthorized" />
        </rule>

        <!-- ============================================================================
             BACKEND PROXY RULES
             These rules only execute after authentication passes above
             ============================================================================ -->

        <!-- 1) CopilotKit proxy server /chat/copilotkit-api/* -> 8001/* -->
        <rule name="CopilotKit Proxy" stopProcessing="true">
          <match url="^copilotkit-api/(.*)$" />
          <action type="Rewrite"
                  url="http://127.0.0.1:8001/{R:1}"
                  appendQueryString="true" />
        </rule>

        <!-- 2) Python backend /chat/backend/* -> 8002/* -->
        <rule name="Python Backend" stopProcessing="true">
          <match url="^backend/(.*)$" />
          <action type="Rewrite"
                  url="http://127.0.0.1:8002/{R:1}"
                  appendQueryString="true" />
        </rule>

        <!-- 3) Data endpoint -->
        <rule name="Data Endpoint" stopProcessing="true">
          <match url="^data(.*)$" />
          <action type="Rewrite"
                  url="http://127.0.0.1:8002/data{R:1}"
                  appendQueryString="true" />
        </rule>

        <!-- 4) SPA Fallback - serve index.html for client-side routing -->
        <rule name="SPA Fallback" stopProcessing="true">
          <match url=".*" />
          <conditions logicalGrouping="MatchAll">
            <!-- Don't rewrite if physical file exists -->
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
            <!-- Don't rewrite backend API calls -->
            <add input="{REQUEST_URI}" pattern="^/chat/(backend|copilotkit-api|data)" negate="true" />
          </conditions>
          <action type="Rewrite" url="/index.html" />
        </rule>
      </rules>

      <!-- Outbound: add X-Accel-Buffering: no to prevent Azure App Gateway buffering -->
      <outboundRules>
        <!-- X-Accel-Buffering for all backend APIs -->
        <rule name="Add X-Accel-Buffering for Backend APIs" preCondition="AllBackendApis">
          <match serverVariable="RESPONSE_X-Accel-Buffering" pattern=".+" negate="true" />
          <action type="Rewrite" value="no" />
        </rule>

        <preConditions>
          <preCondition name="AllBackendApis">
            <!-- Matches all backend APIs, data endpoint, and CopilotKit -->
            <add input="{URL}" pattern="^/(?:chat/)?(backend|data|copilotkit-api)" />
          </preCondition>
        </preConditions>
      </outboundRules>
    </rewrite>

    <!-- Default document -->
    <defaultDocument>
      <files>
        <clear />
        <add value="index.html" />
      </files>
    </defaultDocument>

  </system.webServer>
</configuration>

<!--
================================================================================
  DEPLOYMENT INSTRUCTIONS
================================================================================

  This file contains the authenticated version of the /chat subapplication
  configuration for STATIC FILE deployment (no Node.js server).

  BEFORE DEPLOYING:
  1. Backup the current configuration:
     > cd C:\inetpub\wwwroot\chat
     > copy web.config web.config.backup.$(Get-Date -Format 'yyyyMMdd_HHmmss')

  TO DEPLOY:
  1. Build frontend static files:
     > cd frontend
     > npm run build

  2. Deploy static files to IIS:
     > xcopy /E /Y frontend\out\* C:\inetpub\wwwroot\chat\

  3. Copy this config file:
     > copy iis\web-auth-static.config C:\inetpub\wwwroot\chat\web.config

  4. Ensure services are running:
     - CopilotKit server on port 8001
     - Python backend on port 8002

  5. Restart the /chat application pool:
     - IIS Manager → Application Pools → Right-click "chat" → Recycle
     OR
     - Command: appcmd recycle apppool /apppool.name:chat

  TESTING:
  1. Test UNAUTHENTICATED access (should fail with 401):
     - Clear all cookies in browser (DevTools → Application → Cookies)
     - Navigate to: https://ra37-drmexp-dev-001.drmigrate.com.au/chat/
     - Expected: 401 Unauthorized response

  2. Test AUTHENTICATED access (should succeed):
     - Login to main app: https://ra37-drmexp-dev-001.drmigrate.com.au/
     - This creates .AspNet.Cookies
     - Navigate to: https://ra37-drmexp-dev-001.drmigrate.com.au/chat/
     - Expected: /chat interface loads normally

  3. Test STATIC ASSETS (should work without auth):
     - With cookies cleared, navigate to:
       https://ra37-drmexp-dev-001.drmigrate.com.au/chat/_next/static/...
     - Expected: 200 OK (static file served without auth required)

  TO ROLLBACK (if issues arise):
  1. Restore the backup:
     > copy C:\inetpub\wwwroot\chat\web.config.backup.YYYYMMDD_HHMMSS C:\inetpub\wwwroot\chat\web.config

  2. Restart /chat application pool

================================================================================
  FUTURE MIGRATION TO /SPA
================================================================================

  When static files are served from /spa instead of /chat, this configuration
  becomes a pure API gateway. Comment out the static file serving sections:

  COMMENT OUT (no longer needed):
  - Default document section (lines ~169-175)
  - SPA Fallback rule - Rule 5 (lines ~110-121)

  KEEP ACTIVE (backend proxy rules still use /chat paths):
  - All authentication rules (Rule 0)
  - All backend proxy rules (Rules 1-4: SSE, CopilotKit, Python, Data)
  - All outbound rules (X-Accel-Buffering headers)

  Result: /chat becomes API-only gateway, static frontend served from /spa

================================================================================
-->
