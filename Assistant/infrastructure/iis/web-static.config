<?xml version="1.0" encoding="UTF-8"?>
<!--
================================================================================
  PRODUCTION CONFIGURATION - Static File Serving
================================================================================

  Use this configuration for PRODUCTION deployments where:
  - Frontend is deployed as static files (Next.js output: 'export')
  - Static files are served directly by IIS from the /chat directory
  - No Node.js server running on port 3000

  Deployment Steps:
  1. Build frontend: cd frontend && npm run build
  2. Copy contents of frontend/out/ to C:\inetpub\wwwroot\chat\
  3. Copy this file to: C:\inetpub\wwwroot\chat\web.config
  4. Ensure CopilotKit server is running on port 9000
  5. Ensure Python backend is running on port 8002
  6. Restart IIS or recycle application pool

  For DEVELOPMENT with Node.js server (npx serve), use web.config instead.

================================================================================
-->
<configuration>
  <system.webServer>

    <!-- ARR reverse proxy -->
    <!-- <proxy enabled="true" preserveHostHeader="true" reverseRewriteHostInResponseHeaders="false" /> -->

    <!-- Optional but recommended for SSE -->
    <caching enabled="false" enableKernelCache="false" />
    <urlCompression doDynamicCompression="false" doStaticCompression="false" />

    <!-- CSP Headers -->
    <httpProtocol>
      <customHeaders>
        <remove name="Content-Security-Policy" />
        <add name="Content-Security-Policy"
             value="default-src 'self' https: data:;
                    script-src 'self' 'unsafe-inline';
                    style-src 'self' 'unsafe-inline';
                    img-src 'self' data:;
                    connect-src 'self' https://*.drmigrate.com.au;
                    frame-ancestors 'none';
                    base-uri 'self'" />
      </customHeaders>
    </httpProtocol>

    <rewrite>
      <rules>
        <!-- 1) CopilotKit proxy server /chat/copilotkit-api/* -> 8001/* -->
        <rule name="CopilotKit Proxy" stopProcessing="true">
          <match url="^copilotkit-api/(.*)$" />
          <action type="Rewrite"
                  url="http://127.0.0.1:8001/{R:1}"
                  appendQueryString="true" />
        </rule>

        <!-- 2) Python backend /chat/backend/* -> 8002/* -->
        <rule name="Python Backend" stopProcessing="true">
          <match url="^backend/(.*)$" />
          <action type="Rewrite"
                  url="http://127.0.0.1:8002/{R:1}"
                  appendQueryString="true" />
        </rule>

        <!-- 3) Data endpoint -->
        <rule name="Data Endpoint" stopProcessing="true">
          <match url="^data(.*)$" />
          <action type="Rewrite"
                  url="http://127.0.0.1:8002/data{R:1}"
                  appendQueryString="true" />
        </rule>

        <!-- 4) SPA Fallback - serve index.html for client-side routing -->
        <rule name="SPA Fallback" stopProcessing="true">
          <match url=".*" />
          <conditions logicalGrouping="MatchAll">
            <!-- Don't rewrite if physical file exists -->
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
            <!-- Don't rewrite backend API calls -->
            <add input="{REQUEST_URI}" pattern="^/chat/(backend|copilotkit-api|data)" negate="true" />
          </conditions>
          <action type="Rewrite" url="/index.html" />
        </rule>
      </rules>

      <!-- Outbound: add X-Accel-Buffering: no to prevent Azure App Gateway buffering -->
      <outboundRules>
        <!-- X-Accel-Buffering for all backend APIs -->
        <rule name="Add X-Accel-Buffering for Backend APIs" preCondition="AllBackendApis">
          <match serverVariable="RESPONSE_X-Accel-Buffering" pattern=".+" negate="true" />
          <action type="Rewrite" value="no" />
        </rule>

        <preConditions>
          <preCondition name="AllBackendApis">
            <!-- Matches all backend APIs, data endpoint, and CopilotKit -->
            <add input="{URL}" pattern="^/(?:chat/)?(backend|data|copilotkit-api)" />
          </preCondition>
        </preConditions>
      </outboundRules>
    </rewrite>

    <!-- Default document -->
    <defaultDocument>
      <files>
        <clear />
        <add value="index.html" />
      </files>
    </defaultDocument>

    <!-- Enable static file serving -->
    <staticContent>
      <mimeMap fileExtension=".json" mimeType="application/json" />
    </staticContent>
  </system.webServer>
</configuration>
