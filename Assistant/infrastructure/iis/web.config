<?xml version="1.0" encoding="UTF-8"?>
<!--
================================================================================
  DEVELOPMENT CONFIGURATION - Node.js Server (npx serve or next dev)
================================================================================

  Use this configuration for DEVELOPMENT/TESTING where:
  - Frontend is running with Node.js server on port 3000 (npx serve out -p 3000)
  - IIS proxies requests to the Node.js server
  - Faster iteration for testing changes

  For PRODUCTION with static file serving, use web-static.config instead.
  For PRODUCTION with authentication + static files, use web-auth-static.config.

================================================================================
-->
<configuration>
  <system.webServer>

    <!-- ARR reverse proxy -->
    <!-- <proxy enabled="true" preserveHostHeader="true" reverseRewriteHostInResponseHeaders="false" /> -->

    <!-- Optional but recommended for SSE -->
    <caching enabled="false" enableKernelCache="false" />
    <urlCompression doDynamicCompression="false" doStaticCompression="false" />

    <!-- CSP (remove if you set at higher level to avoid duplicates) -->
    <httpProtocol>
      <!-- <customHeaders>
        <remove name="Content-Security-Policy" />
        <add name="Content-Security-Policy"
             value="default-src 'self' https://ra37-drmexp-dev-001.drmigrate.com.au wss://ra37-drmexp-dev-001.drmigrate.com.au ws: wss: data: blob: 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws: wss: http://localhost:8002; img-src 'self' data: https:;" />
      </customHeaders> -->
            <customHeaders>
        <remove name="Content-Security-Policy" />
        <add name="Content-Security-Policy"
             value="default-src 'self' https: data:;
                    script-src 'self' 'unsafe-inline';
                    style-src 'self' 'unsafe-inline';
                    img-src 'self' data:;
                    connect-src 'self' https://*.drmigrate.com.au;
                    frame-ancestors 'none';
                    base-uri 'self'" />
      </customHeaders>
    </httpProtocol>

    <rewrite>

      <rules>
        <!-- 1) CopilotKit proxy server /chat/copilotkit-api/* -> 8001/* -->
        <rule name="CopilotKit Proxy" stopProcessing="true">
          <match url="^copilotkit-api/(.*)$" />
          <action type="Rewrite"
                  url="http://127.0.0.1:8001/{R:1}"
                  appendQueryString="true" />
        </rule>

        <!-- 2) Python backend /chat/backend/* -> 8002/* -->
        <rule name="Python Backend" stopProcessing="true">
          <match url="^backend/(.*)$" />
          <action type="Rewrite"
                  url="http://127.0.0.1:8002/{R:1}"
                  appendQueryString="true" />
        </rule>

        <!-- 3) Next.js static assets -->
        <rule name="Next.js Static" stopProcessing="true">
          <match url="^_next/(.*)$" />
          <action type="Rewrite"
                  url="http://127.0.0.1:3000/chat/_next/{R:1}"
                  appendQueryString="true" />
        </rule>

        <!-- 4) Next.js API routes -->
        <rule name="Next.js API" stopProcessing="true">
          <match url="^api/(.*)$" />
          <action type="Rewrite"
                  url="http://127.0.0.1:3000/chat/api/{R:1}"
                  appendQueryString="true" />
        </rule>

        <!-- 5) Data endpoint -->
        <rule name="Data Endpoint" stopProcessing="true">
          <match url="^data(.*)$" />
          <action type="Rewrite"
                  url="http://127.0.0.1:8002/data{R:1}"
                  appendQueryString="true" />
        </rule>

        <!-- 6) SPA fallback -->
        <rule name="Chat SPA" stopProcessing="true">
          <match url="^(.*)$" />
          <action type="Rewrite"
                  url="http://127.0.0.1:3000/chat/{R:0}"
                  appendQueryString="true" />
        </rule>
      </rules>

      <!-- Outbound: add X-Accel-Buffering: no to prevent Azure App Gateway buffering -->
<outboundRules>
  <!-- X-Accel-Buffering for all backend APIs -->
  <rule name="Add X-Accel-Buffering for Backend APIs" preCondition="AllBackendApis">
    <match serverVariable="RESPONSE_X-Accel-Buffering" pattern=".+" negate="true" />
    <action type="Rewrite" value="no" />
  </rule>

  <preConditions>
    <preCondition name="AllBackendApis">
      <!-- Matches all backend APIs, data endpoint, and CopilotKit -->
      <add input="{URL}" pattern="^/(?:chat/)?(backend|data|copilotkit-api)" />
    </preCondition>
  </preConditions>
</outboundRules>




    </rewrite>
  </system.webServer>
</configuration>
