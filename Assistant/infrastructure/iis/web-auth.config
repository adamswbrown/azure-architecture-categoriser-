<?xml version="1.0" encoding="UTF-8"?>
<!--
================================================================================
  DEVELOPMENT CONFIGURATION - Node.js Server with Authentication
================================================================================

  Use this configuration for DEVELOPMENT/TESTING where:
  - Frontend is running with Node.js server on port 3000 (npx serve out -p 3000)
  - IIS proxies requests to the Node.js server
  - Authentication is required (.AspNet.Cookies)
  - Faster iteration for testing with auth enabled

  For PRODUCTION with static file serving + auth, use web-auth-static.config.
  For DEVELOPMENT without auth, use web.config.

================================================================================
-->
<configuration>
  <system.webServer>

    <!-- ARR reverse proxy settings are configured in applicationHost.config via location path -->
    <!-- See New-ChatReverseProxyApplication function for configuration -->
    <!-- <proxy> element cannot be set in web.config (AppHostOnly restriction) -->

    <!-- Optional but recommended for SSE -->
    <caching enabled="false" enableKernelCache="false" />
    <urlCompression doDynamicCompression="false" doStaticCompression="false" />

    <!-- CSP (remove if you set at higher level to avoid duplicates) -->
    <httpProtocol>
      <!-- <customHeaders>
        <remove name="Content-Security-Policy" />
        <add name="Content-Security-Policy"
             value="default-src 'self' https://ra37-drmexp-dev-001.drmigrate.com.au wss://ra37-drmexp-dev-001.drmigrate.com.au ws: wss: data: blob: 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws: wss: http://localhost:8002; img-src 'self' data: https:;" />
      </customHeaders> -->
            <customHeaders>
        <remove name="Content-Security-Policy" />
        <add name="Content-Security-Policy"
             value="default-src 'self' https: data:;
                    script-src 'self' 'unsafe-inline';
                    style-src 'self' 'unsafe-inline';
                    img-src 'self' data:;
                    connect-src 'self' https://*.drmigrate.com.au;
                    frame-ancestors 'none';
                    base-uri 'self'" />
      </customHeaders>
    </httpProtocol>

    <rewrite>

      <rules>
        <!-- ============================================================================
             PHASE 1 AUTHENTICATION (NEW)
             Validate that requests have .AspNet.Cookies from main app authentication
             If cookie missing → return 401 Unauthorized
             ============================================================================ -->

        <!-- 0) REQUIRE AUTHENTICATION: Check for .AspNet.Cookies presence -->
        <rule name="Require Authentication Cookie" stopProcessing="true">
          <match url="^(.*)$" />
          <conditions>
            <!-- Check if .AspNet.Cookies cookie is missing (negate=true means "if NOT found") -->
            <add input="{HTTP_COOKIE}" pattern="\.AspNet\.Cookies" negate="true" />

            <!-- EXCEPTION 1: Allow static assets and CopilotKit API (they don't need auth) -->
            <add input="{REQUEST_URI}" pattern="^/chat/(_next|\.well-known|favicon|copilotkit-api)" negate="true" />
          </conditions>
          <action type="CustomResponse" statusCode="401" statusReason="Unauthorized" />
        </rule>

        <!-- ============================================================================
             ORIGINAL PROXY RULES (UNCHANGED)
             These rules now only execute after authentication passes above
             ============================================================================ -->

        <!-- 1) CopilotKit proxy server /chat/copilotkit-api/* -> 8001/* -->
        <rule name="CopilotKit Proxy" stopProcessing="true">
          <match url="^copilotkit-api/(.*)$" />
          <action type="Rewrite"
                  url="http://127.0.0.1:8001/{R:1}"
                  appendQueryString="true" />
        </rule>

        <!-- 2) Python backend /chat/backend/* -> 8002/* -->
        <rule name="Python Backend" stopProcessing="true">
          <match url="^backend/(.*)$" />
          <action type="Rewrite"
                  url="http://127.0.0.1:8002/{R:1}"
                  appendQueryString="true" />
        </rule>

        <!-- 3) Next.js static assets -->
        <rule name="Next.js Static" stopProcessing="true">
          <match url="^_next/(.*)$" />
          <action type="Rewrite"
                  url="http://127.0.0.1:3000/chat/_next/{R:1}"
                  appendQueryString="true" />
        </rule>

        <!-- 4) Next.js API routes -->
        <rule name="Next.js API" stopProcessing="true">
          <match url="^api/(.*)$" />
          <action type="Rewrite"
                  url="http://127.0.0.1:3000/chat/api/{R:1}"
                  appendQueryString="true" />
        </rule>

        <!-- 5) Data endpoint -->
        <rule name="Data Endpoint" stopProcessing="true">
          <match url="^data(.*)$" />
          <action type="Rewrite"
                  url="http://127.0.0.1:8002/data{R:1}"
                  appendQueryString="true" />
        </rule>

        <!-- 6) SPA fallback -->
        <rule name="Chat SPA" stopProcessing="true">
          <match url="^(.*)$" />
          <action type="Rewrite"
                  url="http://127.0.0.1:3000/chat/{R:0}"
                  appendQueryString="true" />
        </rule>
      </rules>

      <!-- Outbound: add X-Accel-Buffering: no to prevent Azure App Gateway buffering -->
<outboundRules>
  <!-- X-Accel-Buffering for all backend APIs -->
  <rule name="Add X-Accel-Buffering for Backend APIs" preCondition="AllBackendApis">
    <match serverVariable="RESPONSE_X-Accel-Buffering" pattern=".+" negate="true" />
    <action type="Rewrite" value="no" />
  </rule>

  <preConditions>
    <preCondition name="AllBackendApis">
      <!-- Matches all backend APIs, data endpoint, and CopilotKit -->
      <add input="{URL}" pattern="^/(?:chat/)?(backend|data|copilotkit-api)" />
    </preCondition>
  </preConditions>
</outboundRules>




    </rewrite>
  </system.webServer>
</configuration>

<!--
================================================================================
  DEPLOYMENT INSTRUCTIONS FOR PHASE 1
================================================================================

  This file (web-auth.config) contains the authenticated version of the /chat
  subapplication configuration with cookie-based authentication enabled.

  BEFORE DEPLOYING:
  1. Backup the current configuration:
     > cd C:\inetpub\wwwroot\chat
     > copy web.config web.config.backup.20251112

  TO DEPLOY PHASE 1:
  1. Copy this file to replace the current web.config:
     > copy C:\path\to\web-auth.config C:\inetpub\wwwroot\chat\web.config

  2. Restart the /chat application pool:
     - IIS Manager → Application Pools → Right-click "chat" → Recycle
     OR
     - Command: appcmd recycle apppool /apppool.name:chat

  TESTING PHASE 1:
  1. Test UNAUTHENTICATED access (should fail with 401):
     - Clear all cookies in browser (DevTools → Application → Cookies)
     - Navigate to: https://ra37-drmexp-dev-001.drmigrate.com.au/chat/
     - Expected: 401 Unauthorized response

  2. Test AUTHENTICATED access (should succeed):
     - Login to main app: https://ra37-drmexp-dev-001.drmigrate.com.au/
     - This creates .AspNet.Cookies
     - Navigate to: https://ra37-drmexp-dev-001.drmigrate.com.au/chat/
     - Expected: /chat interface loads normally

  3. Test STATIC ASSETS (should work without auth):
     - With cookies cleared, navigate to:
       https://ra37-drmexp-dev-001.drmigrate.com.au/chat/_next/static/...
     - Expected: 200 OK (static file served without auth required)

  TO ROLLBACK (if issues arise):
  1. Restore the backup:
     > copy C:\inetpub\wwwroot\chat\web.config.backup.20251112 C:\inetpub\wwwroot\chat\web.config

  2. Restart /chat application pool:
     > appcmd recycle apppool /apppool.name:chat

  3. /chat will be public again (unauthenticated access allowed)

================================================================================
  AUTHENTICATION RULE EXPLANATION
================================================================================

  Rule: "Require Authentication Cookie"

  How it works:
  1. Checks every request to /chat
  2. Looks for .AspNet.Cookies cookie in HTTP_COOKIE header
  3. If cookie NOT found (negate=true):
     - AND request is NOT to static assets (_next, .well-known, favicon)
     - THEN return 401 Unauthorized and stop processing

  Exceptions (allowed without auth):
  - /chat/_next/* (Next.js built JavaScript/CSS)
  - /chat/.well-known/* (Web standards like .well-known/security.txt)
  - /chat/favicon.ico (Browser favicon request)

  Why these exceptions?
  - Static assets are public and don't require authentication
  - Browsers request favicon automatically
  - Skipping auth for these prevents unnecessary 401 errors

  Note: If cookie is present, all other rules execute normally:
  - Reverse proxy to Python backend (port 8002)
  - Reverse proxy to Next.js (port 3000)
  - SPA fallback routing

================================================================================
  MONITORING & TROUBLESHOOTING
================================================================================

  IIS Logs:
  - Location: C:\inetpub\logs\LogFiles\W3SVC[SiteID]\
  - Look for 401 status codes on /chat routes
  - Should see 401 for unauthenticated requests
  - Should see 200 for authenticated requests

  Testing with curl (Windows PowerShell):

  # Without cookie (should get 401):
  > Invoke-WebRequest https://ra37-drmexp-dev-001.drmigrate.com.au/chat/ -SkipCertificateCheck

  # With authentication (requires previous login to set cookie):
  > $session = New-Object Microsoft.PowerShell.Commands.WebRequestSession
  > Invoke-WebRequest https://ra37-drmexp-dev-001.drmigrate.com.au/chat/ -WebSession $session -SkipCertificateCheck

================================================================================
-->
